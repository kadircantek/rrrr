{
  "rules": {
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        
        "email": {
          ".validate": "newData.isString()"
        },
        
        "displayName": {
          ".validate": "newData.isString()"
        },
        
        "createdAt": {
          ".validate": "newData.isString()"
        },
        
        "api_keys": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid",
          "$exchangeId": {
            ".validate": "newData.hasChildren(['api_key', 'api_secret', 'status']) && newData.child('api_key').isString() && newData.child('api_secret').isString() && newData.child('status').isString()"
          }
        },
        
        "auto_trading": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid",
          ".validate": "newData.hasChildren(['enabled', 'watchlist', 'interval', 'exchange'])",
          "enabled": {
            ".validate": "newData.isBoolean()"
          },
          "watchlist": {
            ".validate": "newData.hasChildren()"
          }
        },
        
        "profile": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid"
        },
        
        "settings": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid"
        },
        
        "positions": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid",
          "$positionId": {
            ".validate": "newData.hasChildren(['symbol', 'type', 'entryPrice', 'amount', 'timestamp'])"
          }
        },
        
        "trades": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid",
          "$tradeId": {
            ".validate": "newData.hasChildren(['symbol', 'side', 'price', 'quantity', 'timestamp'])"
          }
        }
      }
    },
    
    "signals": {
      ".read": "auth != null",
      ".indexOn": ["user_id", "timestamp"],
      "$signal_id": {
        ".read": "data.child('user_id').val() === auth.uid",
        ".write": "data.child('user_id').val() === auth.uid || !data.exists()",
        ".validate": "newData.hasChildren(['user_id', 'symbol', 'signal_type', 'timestamp'])"
      }
    },
    
    "user_subscriptions": {
      "$uid": {
        ".read": "$uid === auth.uid || root.child('user_roles').child(auth.uid).child('role').val() === 'admin'",
        ".write": "$uid === auth.uid || root.child('user_roles').child(auth.uid).child('role').val() === 'admin'"
      }
    },

    "subscriptions": {
      "$email_key": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    
    "user_roles": {
      "$uid": {
        ".read": "$uid === auth.uid || root.child('user_roles').child(auth.uid).child('role').val() === 'admin'",
        ".write": "root.child('user_roles').child(auth.uid).child('role').val() === 'admin'",
        "role": {
          ".validate": "newData.isString() && (newData.val() === 'admin' || newData.val() === 'user')"
        },
        "updatedAt": {
          ".validate": "newData.isString()"
        }
      }
    },
    
    "public": {
      ".read": true,
      ".write": false,
      "config": {
        ".read": true
      },
      "announcements": {
        ".read": true
      }
    }
  }
}
